# 微信自动化上传系统技术文档

## 目录

1. [概述](#概述)
2. [系统架构](#系统架构)
3. [组件详解](#组件详解)
    - [1. ItChatHandler](#1-itchathandler)
    - [2. MessageHandler](#2-messagehandler)
    - [3. AutoClicker](#3-autoclicker)
    - [4. Uploader](#4-uploader)
    - [5. AutoDownloadManager](#5-autodownloadmanager)
    - [6. ErrorHandler](#6-errorhandler)
    - [7. Notifier](#7-notifier)
    - [8. AdminCommandsHandler](#8-admincommandshandler)
    - [9. PointManager](#9-pointmanager)
    - [10. StatisticsManager](#10-statisticsmanager)
    - [11. XKW](#11-xkw)
4. [工作流程](#工作流程)
5. [配置说明](#配置说明)
6. [部署与设置](#部署与设置)
7. [故障排除](#故障排除)
8. [安全性与最佳实践](#安全性与最佳实践)
9. [未来规划](#未来规划)
10. [附录](#附录)
11. [版本更新日志](#版本更新日志)
12. [许可证](#许可证)

---

## 概述

本技术文档详细介绍了微信自动化上传系统的架构、各组件功能及其相互作用。该系统基于Python和ItChat库，主要用于监控指定微信群组和个人中的消息，提取URL链接，自动下载相关文件，并将文件上传回微信群组。系统还具备错误处理和通知功能，确保在出现问题时及时反馈。此外，系统引入了管理员功能，允许管理员执行特定命令，如查询日志和浏览器状态。

## 系统架构

微信自动化上传系统采用模块化设计，主要包括以下关键组件：

1. **ItChatHandler**：负责与微信的交互，包括登录、监听群组和个人消息等。
2. **MessageHandler**：处理从群组和个人接收到的消息，提取URL链接并进行验证。
3. **AutoClicker**：自动化处理提取的URL，如打开链接以触发下载，并自动退出浏览器。
4. **Uploader**：将下载的文件上传到指定的微信群组。
5. **AutoDownloadManager**：管理下载任务，包括任务调度和多实例浏览器控制。
6. **ErrorHandler**：捕捉并处理系统运行中的异常，确保系统稳定性。
7. **Notifier**：负责发送通知，如错误报告、操作反馈和管理员命令响应。
8. **AdminCommandsHandler**：处理管理员发送的特定命令，如添加/删除接收者、查询日志和浏览器状态。
9. **PointManager**：管理系统中的积分，包括群组、用户和个人接收者的积分。
10. **StatisticsManager**：管理和记录系统的统计数据，如任务提交、成功、失败次数及下载时间。
11. **XKW**：负责具体的下载任务执行，包括浏览器控制、下载管理和任务重试。

各组件通过事件驱动和回调机制相互协作，共同完成消息监控、文件下载与上传的自动化流程。

## 组件详解

### 1. ItChatHandler

**作用**：

- 负责与微信客户端建立连接，处理登录过程。
- 监听指定微信群组和个人中的消息，并将消息传递给MessageHandler进行处理。
- 支持多群组和多个人的监控和上传功能。
- 连接Uploader功能，实现对应群组的文件上传功能。
- 记录群组或个人发送的链接ID，并传送到`upload_urls`列表。
- 支持管理员功能，允许管理员执行特定命令，如查询日志和浏览器状态。

**逻辑**：

1. **登录微信**：通过ItChat库实现微信登录，支持二维码扫描登录和热重载功能。改进后删除旧的会话文件，确保每次登录都是全新的会话。
2. **初始化会话**：获取并更新微信中的群组和个人信息，确保能够正确识别和监听目标群组和个人。
3. **消息监听**：注册消息处理函数，监听群组和个人中的各种消息类型（如文本、附件、分享等）。
4. **回调处理**：将接收到的消息传递给MessageHandler进行进一步处理。
5. **二维码处理**：改进后的二维码回调功能，不仅保存二维码图片，还将二维码数据发送到GUI队列以支持图形界面显示。
6. **管理员命令支持**：支持管理员通过特定命令与系统交互，如添加或删除接收者，更新剩余次数等。

**更新内容**：

- **配置管理集成**：引入`ConfigManager`，通过配置文件动态加载监控群组、个人和管理员列表等配置参数。
- **管理员支持**：引入`AdminCommandsHandler`，处理管理员发送的命令，如查询日志、查看浏览器状态等。
- **错误处理与日志记录**：增强了错误处理机制，确保在登录或运行过程中出现问题时能够及时记录并通知。
- **Uploader绑定**：允许外部绑定Uploader实例，以便在消息处理后进行文件上传。
- **二维码回调增强**：二维码图片不仅保存到本地，还发送到GUI队列，支持图形界面显示。
- **会话管理优化**：在登录过程中删除旧的会话文件，确保每次登录都是全新的会话，避免会话冲突。

### 2. MessageHandler

**作用**：

- 处理来自微信群组和个人的消息，提取其中的URL链接。
- 验证提取的URL是否符合预定义的规则，并触发相应的自动化操作。
- 支持管理员命令，如添加/删除接收者、更新剩余次数、查询接收者信息等。
- 支持管理员命令，如查询日志和浏览器状态。

**逻辑**：

1. **消息解析**：接收ItChatHandler传递的消息对象，提取消息内容。
2. **URL提取**：使用正则表达式从消息内容中提取所有符合条件的URL链接。
3. **URL验证**：根据配置中的规则，验证提取的URL是否合法有效。
4. **触发自动化操作**：对于通过验证的URL，调用AutoClicker模块进行后续处理，如打开链接以启动文件下载。
5. **管理员命令处理**：
    - **添加接收者**：允许管理员添加新的接收者，并设置初始下载次数。
    - **删除接收者**：允许管理员删除现有接收者。
    - **更新剩余次数**：允许管理员更新接收者的剩余下载次数。
    - **查询接收者信息**：允许管理员查询特定接收者的剩余次数。
    - **获取所有接收者**：允许管理员获取所有接收者的列表。
    - **帮助命令**：提供可用命令的帮助信息。

**更新内容**：

- **管理员命令支持**：新增处理管理员发送的特定命令，如添加/删除接收者，更新剩余次数，查询接收者信息，获取所有接收者，以及帮助命令。
- **日志管理**：能够读取并发送最新的日志内容，帮助管理员快速了解系统状态。
- **浏览器控制器集成**：支持通过命令捕获浏览器标签页的截图，并将截图发送给管理员。
- **增强的消息处理**：支持处理更多类型的消息（如分享类型），并根据消息来源（群组或个人）进行不同的处理逻辑。

### 3. AutoClicker

**作用**：

- 自动化处理提取的URL链接，将URL添加到下载任务队列中，自动触发文件下载。
- 管理浏览器实例，确保下载过程顺利进行，并在必要时自动退出浏览器以释放资源。

**逻辑**：

1. **打开URL**：接收MessageHandler传递的有效URL链接，使用系统默认浏览器或指定的浏览器自动打开链接。
2. **启动下载**：通过打开链接触发文件的自动下载，确保下载过程顺利进行。
3. **反馈机制**：在需要时，提供下载启动的日志记录或通知。
4. **浏览器自动退出**：防止浏览器页面打开过多，导致文件下载异常，自动退出浏览器释放资源。

**更新内容**：

- **线程安全与并发控制**：使用线程锁（`threading.Lock`）确保在多线程环境下对共享资源的安全访问。
- **下载任务管理**：集成了`XKW`类，通过多线程和任务队列（`queue.Queue`）管理下载任务，支持批量和单个URL的下载。
- **错误处理**：在各个下载步骤中捕捉并处理异常，确保系统稳定性。
- **日志记录**：详细记录每个下载任务的状态，包括成功、失败及重试信息。

### 4. Uploader

**作用**：

- 连接ItChatHandler和AutoDownloadManager，将下载完成的文件上传回指定的微信群组，实现计数功能。
- 管理上传任务队列和多线程处理，确保高效稳定的文件上传。
- 维护接收者的下载计数和剩余量，并通过每日通知系统向管理员报告系统状态。

**逻辑**：

1. **文件检查**：确认下载的文件存在且已完成下载（大小稳定）。
2. **文件重命名**：将文件名修改为 `[soft_id]原文件名`，便于追踪和管理。
3. **上传任务管理**：
    - 使用独立的上传线程和上传任务队列（`queue.Queue`）管理上传任务。
    - 支持多线程并发上传，提高上传效率。
4. **文件上传**：
    - 切换到指定的聊天窗口。
    - 使用wxauto库发送文件到目标微信群组或个人联系人。
    - 实现重试机制，确保上传成功。
5. **计数器集成**：
    - 使用SQLite数据库记录每个接收者的下载计数和剩余量。
    - 扣除上传成功后的剩余次数，并记录每日下载量。
6. **每日通知系统**：
    - 定时每天晚上10点半发送下载量和剩余量的通知消息到指定的群组或个人账号。
    - 重置每日下载计数，准备新的统计周期。
7. **错误处理与日志记录**：
    - 捕捉上传过程中的异常，通过ErrorHandler进行统一处理。
    - 记录详细的日志，便于后续追踪和调试。
8. **管理员命令支持**：
    - 允许管理员通过命令添加、删除接收者，更新剩余次数，以及查询接收者信息。

**更新内容**：

- **多线程上传处理**：通过独立的上传线程和上传任务队列（`queue.Queue`）管理上传任务，确保高效处理多个文件上传请求。
- **错误通知**：在上传失败时，通过`ErrorHandler`和`Notifier`模块发送错误通知，确保及时响应和处理问题。
- **文件重命名与管理**：在上传前对文件进行重命名，确保文件名中包含`soft_id`，便于追踪和管理。
- **计数器集成**：维护每个接收者的下载计数和剩余量，定期保存和更新计数器数据，支持每日下载量统计和通知。
- **每日通知系统**：定时发送每日下载量和剩余量的通知消息到指定的群组或个人账号，帮助管理员了解系统运行状态。
- **数据库管理**：集成SQLite数据库，管理接收者信息、下载记录和计数器数据。
- **管理员命令支持**：新增方法支持管理员添加、删除接收者，更新剩余次数，以及查询接收者信息。

### 5. AutoDownloadManager

**作用**：

- 管理下载任务，包括任务调度和多实例浏览器控制。
- 负责协调多个下载实例（XKW），确保下载任务的高效分配和执行。
- 处理下载任务的添加、分配和管理，提升系统的扩展性和稳定性。

**逻辑**：

1. **初始化管理器**：创建多个浏览器实例，每个实例负责处理一定数量的下载任务，确保下载过程的并行化和高效性。
2. **任务分配**：通过轮询或其他调度算法，将下载任务分配给不同的XKW实例，避免单个实例过载。
3. **任务调度**：管理下载任务的队列，确保任务按照优先级和顺序被处理。
4. **资源管理**：监控各个浏览器实例的状态，动态调整任务分配，确保系统资源的合理利用。
5. **错误处理与重试**：在下载任务失败时，协调其他实例进行任务重试，提升任务完成率。

**更新内容**：

- **多实例浏览器控制**：支持同时管理多个浏览器实例（XKW），提升下载任务的处理能力。
- **任务调度优化**：通过更智能的任务分配策略，优化任务的执行顺序和资源利用。
- **扩展性增强**：允许根据系统负载动态增加或减少浏览器实例，提升系统的可扩展性。
- **集成ErrorHandler和Notifier**：在任务调度和执行过程中出现异常时，通过ErrorHandler和Notifier进行统一处理和通知。

### 6. ErrorHandler

**作用**：

- 捕捉并处理系统运行中的各种异常，确保系统的稳定性和可靠性。

**逻辑**：

1. **异常捕捉**：在各个模块中捕捉到的异常会传递给ErrorHandler进行统一处理。
2. **日志记录**：详细记录异常信息，包括异常类型、堆栈跟踪等，便于问题排查。
3. **通知发送**：通过Notifier模块，向指定的接收者发送错误通知，确保及时响应和修复问题。
4. **状态检查**：在发送通知前，确认微信的登录状态，避免因微信未登录导致进一步的错误。

**更新内容**：

- **集中式异常处理**：所有模块的异常均通过ErrorHandler进行统一处理，简化错误管理。
- **增强的日志记录**：详细记录每个异常的上下文信息，便于快速定位和修复问题。
- **通知集成**：与Notifier模块紧密集成，确保在发生严重错误时能够及时通知管理员或相关人员。

### 7. Notifier

**作用**：

- 负责发送各种通知，如错误报告、操作反馈和管理员命令响应，确保用户能够及时了解系统状态。

**逻辑**：

1. **通知类型**：支持多种通知方式，如通过微信、邮件、日志等。
2. **消息格式**：根据通知类型，格式化消息内容，确保信息传递的准确性和清晰度。
3. **发送机制**：调用相应的API或接口，发送通知消息到指定的接收者或平台。
4. **错误处理**：在发送通知过程中，如果发生异常，通过ErrorHandler模块进行处理，避免递归错误。

**更新内容**：

- **多种通知渠道支持**：支持通过微信发送通知，未来可扩展至邮件、Slack等其他平台。
- **管理员命令响应**：针对管理员发送的命令，格式化并发送相应的反馈消息，如日志内容和浏览器截图。
- **长消息处理**：实现长消息的分段发送，确保超过限制的消息能够完整传达。
- **图像通知支持**：支持发送截图或其他图像文件，满足管理员命令中对浏览器截图的需求。

### 8. AdminCommandsHandler

**作用**：

- 处理管理员发送的特定命令，如添加/删除接收者、查询日志和浏览器状态。

**逻辑**：

1. **命令解析**：解析管理员发送的命令，识别命令类型及其参数。
2. **命令执行**：根据解析结果，执行相应的操作，如添加接收者、删除接收者、查询日志等。
3. **反馈响应**：将命令执行的结果通过Notifier发送给管理员，确保管理员能够及时了解操作结果。
4. **权限验证**：确保只有在`admins`列表中的用户能够执行管理员命令，保障系统安全性。

**更新内容**：

- **集成到MessageHandler**：作为MessageHandler的一部分，专门处理来自管理员的命令。
- **支持更多命令**：扩展支持更多管理员命令，如查看系统状态、重启服务等。
- **错误处理**：在命令执行过程中捕捉并处理可能出现的异常，确保系统稳定性。

### 9. PointManager

**作用**：

- 管理系统中的积分，包括群组、用户和个人接收者的积分。
- 提供接口用于增加、扣除和查询积分，确保积分的准确性和一致性。
- 维护群组信息，包括群组名称、剩余积分和群组类型（整体性或非整体性）。
- 管理用户信息，确保用户在群组中的积分管理。
- 处理接收者（个人）的积分管理，包括添加、删除和更新积分。

**逻辑**：

1. **数据库初始化**：创建数据库表格，用于存储群组、用户和接收者的信息。
2. **确保实体存在**：在操作积分前，确保群组、用户或接收者已经存在于数据库中。
3. **积分检查**：提供方法检查群组、用户或接收者是否有足够的积分。
4. **积分扣除**：根据不同类型（整体性群组、非整体性群组、个人），扣除相应的积分。
5. **积分更新**：允许管理员通过命令增加或减少接收者的积分。
6. **信息查询**：提供接口查询接收者、群组和用户的积分信息。
7. **线程安全**：使用线程锁确保在多线程环境下对数据库的安全访问。

**数据库结构**：

- **groups** 表：
  - `name`：群组名称（主键）。
  - `remaining_points`：群组剩余积分。
  - `is_whole`：是否为整体性群组（0 非整体，1 整体）。
  
- **users** 表：
  - `group_name`：群组名称（外键）。
  - `nickname`：用户昵称。
  - `remaining_points`：用户剩余积分。
  - 主键为 (`group_name`, `nickname`)。
  
- **recipients** 表：
  - `name`：接收者名称（主键）。
  - `remaining_points`：接收者剩余积分。

**更新内容**：

- **积分管理集成**：新增 PointManager 模块，负责管理系统中的积分，包括群组、用户和个人接收者的积分。
- **数据库支持**：PointManager 使用 SQLite 数据库存储和管理积分数据，确保数据的持久性和一致性。
- **多线程支持**：PointManager 使用线程锁确保在多线程环境下对数据库的安全访问，防止数据竞争和不一致。
- **积分操作方法**：提供方法用于添加接收者、删除接收者、更新积分、查询积分等，供其他模块调用。
- **积分扣除逻辑**：在Uploader上传文件成功后，通过PointManager扣除相应接收者的积分。
- **管理员命令集成**：管理员可以通过命令增加或减少接收者的积分，PointManager提供相应的接口进行操作。

**交互**：

- **Uploader**：在上传文件成功后，通过 PointManager 扣除相应接收者的积分。
- **AdminCommandsHandler**：管理员可以通过命令添加、删除接收者，更新积分，这些操作通过 PointManager 完成。

### 10. StatisticsManager

**作用**：

- 管理和记录系统的统计数据，包括任务提交、成功、失败次数及下载时间。
- 提供实时统计数据查询和日志记录，帮助管理员了解系统运行状况。
- 实现统计数据的持久化，确保数据在系统重启后依然可用。

**逻辑**：

1. **单例模式**：确保系统中只有一个StatisticsManager实例，统一管理统计数据。
2. **统计数据记录**：
    - **任务提交**：记录每个下载任务的提交次数。
    - **任务成功**：记录成功完成的任务数量及总下载时间。
    - **任务失败**：记录失败的任务数量。
3. **统计数据查询**：提供接口查询当前的统计数据，如总任务数、成功任务数、失败任务数、平均下载时间和成功率。
4. **日志记录**：定期将统计数据记录到日志中，便于追踪和分析。
5. **数据持久化**：
    - **保存统计数据**：将统计数据保存到本地文件，确保数据持久性。
    - **加载统计数据**：系统启动时，从本地文件加载之前的统计数据。
6. **自动保存**：开启后台线程，定期自动保存统计数据，防止数据丢失。

**更新内容**：

- **单例实例初始化**：确保StatisticsManager在系统中唯一存在，避免数据冲突。
- **自动保存功能**：通过后台线程定期保存统计数据，提升数据安全性。
- **增强的统计记录**：详细记录每个下载任务的状态和时间，提供更全面的统计信息。
- **错误处理**：在记录和保存统计数据时，捕捉并处理可能的异常，确保系统稳定性。

### 11. XKW

**作用**：

- 负责具体的下载任务执行，包括浏览器控制、下载管理和任务重试。
- 管理浏览器标签页，确保下载过程的顺利进行。
- 实现任务的重试机制，提升下载任务的成功率。
- 记录下载任务的统计数据，并与Uploader和StatisticsManager进行交互。

**逻辑**：

1. **浏览器控制**：通过DrissionPage库控制Chromium浏览器，管理多个标签页用于并行下载。
2. **下载任务管理**：
    - **任务队列**：维护一个下载任务队列，按顺序处理下载请求。
    - **任务执行**：从队列中获取下载任务，执行下载操作。
3. **任务重试**：在下载失败或出现异常时，按照设定的重试次数进行重试，确保任务尽可能完成。
4. **文件匹配与验证**：
    - **文件匹配**：根据下载链接匹配已下载的文件，确保文件正确下载。
    - **文件验证**：通过检查文件大小稳定性，确认文件下载完成。
5. **统计数据记录**：在下载任务完成后，记录成功或失败的统计数据，更新StatisticsManager。
6. **任务分发与同步**：与AutoDownloadManager协作，确保任务的合理分配和同步执行。
7. **错误处理与通知**：在下载过程中出现错误时，通过ErrorHandler和Notifier发送通知，确保及时响应问题。

**更新内容**：

- **多标签页管理**：支持同时管理多个浏览器标签页，提高下载效率。
- **任务重试机制**：实现更智能的重试策略，包括指数退避和浏览器实例切换，提升下载任务的成功率。
- **下载状态同步**：与StatisticsManager和Uploader进行紧密的状态同步，确保统计数据的准确性和上传任务的顺利进行。
- **增强的错误处理**：在下载过程中捕捉更多类型的异常，确保系统的鲁棒性和稳定性。
- **资源释放优化**：下载完成后自动释放浏览器资源，避免资源泄漏和性能下降。

## 工作流程

1. **系统启动**：
   - 系统加载配置文件，初始化各个模块（ItChatHandler、MessageHandler、AutoClicker、Uploader、AutoDownloadManager、ErrorHandler、Notifier、AdminCommandsHandler、PointManager、StatisticsManager、XKW）。
   - ItChatHandler登录微信，并获取目标群组和个人的UserName信息。

2. **消息监控与处理**：
   - ItChatHandler监听指定微信群组和个人的消息，接收到新消息后，将消息传递给MessageHandler。
   - MessageHandler解析消息内容，提取URL链接，并进行验证。
   - 对于通过验证的URL，MessageHandler调用AutoClicker模块自动打开链接，启动文件下载。

3. **文件下载与上传**：
   - AutoClicker通过XKW模块处理下载任务，自动下载文件到本地指定目录。
   - 下载完成后，AutoClicker将文件路径和对应的`soft_id`传递给Uploader。
   - Uploader将文件上传到指定的微信群组，并更新下载计数和剩余量。

4. **下载任务管理**：
   - AutoDownloadManager协调多个XKW实例，分配下载任务，确保任务的高效执行。
   - XKW实例执行具体的下载操作，记录下载状态并与StatisticsManager同步统计数据。

5. **积分管理**：
   - Uploader在文件上传成功后，通过PointManager扣除相应接收者的积分。
   - PointManager确保群组、用户或个人接收者有足够的积分进行扣除。

6. **管理员命令处理**：
   - 管理员发送特定命令（如添加/删除接收者、更新剩余次数、查询接收者信息、获取所有接收者、查询日志、查询浏览器状态）。
   - MessageHandler识别命令并委托AdminCommandsHandler执行相应操作，通过Notifier模块将结果反馈给管理员。

7. **统计数据记录与报告**：
   - StatisticsManager记录每个下载任务的提交、成功、失败次数及下载时间。
   - 每日定时通过Notifier模块发送统计报告给管理员，帮助其了解系统运行状况。

8. **错误处理与通知**：
   - 在各个步骤中，如果发生异常，ErrorHandler捕捉并记录错误。
   - ErrorHandler通过Notifier模块发送错误通知，确保用户及时了解并处理问题。

## 配置说明

系统通过`config.json`文件进行配置，涵盖了微信登录信息、监控群组和个人、文件上传设置、日志记录、错误通知等各个方面。以下是各配置项的说明：

- **wechat**:
  - `login_qr_path`: 存储微信登录二维码的路径。
  - `monitor_groups`: 需要监控的微信群组名称列表。
  - `target_individuals`: 需要监控的个人联系人名称列表。
  - `admins`: 管理员列表，允许执行特定命令。
  - `group_types`:
    - `whole_groups`: 作为整体进行积分检查的群组名称列表。
    - `non_whole_groups`: 需要对群组内的个人进行积分检查的群组名称列表。
  - `itchat`:
    - `qr_check`:
      - `max_retries`: 最大重试次数，用于二维码扫描登录。
      - `retry_interval`: 重试间隔时间（秒）。

- **url**:
  - `regex`: 用于匹配消息中的URL链接的正则表达式。
  - `validation`: 是否启用URL验证。

- **download**:
  - `download_path`: 本地下载目录的路径。
  - `allowed_extensions`: 允许下载的文件扩展名列表。
  - `temporary_extensions`: 临时文件扩展名列表，用于识别未完成的下载文件。
  - `stable_time`: 文件大小稳定时间（秒），用于确认文件已下载完成。

- **upload**:
  - `target_groups`: 需要上传文件或分享链接的微信群组名称列表。
  - `target_individuals`: 需要上传文件的个人联系人名称列表。
  - `counts_file`: 计数器配置文件的路径，用于记录每日下载量和剩余量。
  - `database_path`: SQLite数据库文件的路径。

- **logging**:
  - `level`: 日志记录的级别（如INFO、DEBUG、ERROR）。
  - `file`: 日志文件的存储路径。
  - `directory`: 日志目录，用于存储多个日志文件。

- **error_notification**:
  - `method`: 错误通知的方式（如wechat、email等）。
  - `recipient`: 错误通知的接收者（如微信好友或群组）。
  - `error_recipient`: 错误通知的专用接收者（可选）。

**注意事项**：

- 配置文件必须为有效的JSON格式，不能包含注释。
- 确保所有路径和群组、个人名称与实际情况一致，避免因配置错误导致功能失效。
- 根据企业微信的具体文件大小限制，调整上传逻辑和配置参数。
- 管理员功能需要在`admins`列表中正确配置管理员名称，确保只有授权用户可以执行特定命令。

**示例 `config.json`**：

```json
{
  "wechat": {
    "login_qr_path": "qr.png",
    "monitor_groups": ["群组1", "群组2"],
    "target_individuals": ["个人1", "个人2"],
    "admins": ["管理员1", "管理员2"],
    "group_types": {
      "whole_groups": ["群组1"],
      "non_whole_groups": ["群组2"]
    },
    "itchat": {
      "qr_check": {
        "max_retries": 5,
        "retry_interval": 2
      }
    }
  },
  "url": {
    "regex": "https?://[^\\s\"」]+",
    "validation": true
  },
  "download": {
    "download_path": "downloads/",
    "allowed_extensions": [".exe", ".zip"],
    "temporary_extensions": [".part", ".crdownload"],
    "stable_time": 10
  },
  "upload": {
    "target_groups": ["上传群组1"],
    "target_individuals": ["上传个人1"],
    "counts_file": "counts.json",
    "database_path": "data/database.sqlite"
  },
  "logging": {
    "level": "DEBUG",
    "file": "logs/system.log",
    "directory": "logs/"
  },
  "error_notification": {
    "method": "wechat",
    "recipient": "管理员群组",
    "error_recipient": "错误通知群组"
  }
}
```

## 部署与设置

1. **环境准备**：
   - 安装Python 3.7及以上版本。
   - 安装项目依赖库，可以通过`pip install -r requirements.txt`完成。

2. **配置文件设置**：
   - 编辑`config.json`文件，根据实际需求配置各项参数，如监控群组、个人、下载路径、上传目标等。

3. **运行系统**：
   - 启动主程序，系统将自动登录微信并开始监控指定的群组和个人消息。

4. **管理员功能**：
   - 确保管理员已在配置文件中正确设置，可以通过发送特定命令来管理接收者、查询系统日志或浏览器状态。

## 故障排除

- **无法登录微信**：
  - 检查`login_qr_path`路径是否正确，确保二维码能够正常生成和扫描。
  - 确保网络连接正常，微信服务器未发生故障。

- **消息未被处理**：
  - 确认监控的群组和个人名称是否正确配置在`config.json`中。
  - 检查日志文件，查看是否有错误信息。

- **文件下载失败**：
  - 确认`download_path`路径存在且有写入权限。
  - 检查URL是否有效，且符合配置中的正则表达式和验证规则。

- **文件上传失败**：
  - 确认目标上传群组或个人存在且名称正确。
  - 检查微信是否已成功登录，并且Uploader模块已正确绑定。

- **管理员命令无响应**：
  - 确认发送命令的用户在`admins`列表中。
  - 检查AdminCommandsHandler是否正常运行，日志中是否有相关错误。

- **积分不足**：
  - 检查PointManager中的接收者或群组的剩余积分是否足够。
  - 通过管理员命令查询接收者或群组的积分情况。

## 安全性与最佳实践

- **配置文件保护**：确保`config.json`文件的权限设置正确，避免未授权人员访问。
- **管理员权限管理**：仅授权可信用户为管理员，避免滥用管理员命令。
- **日志管理**：定期清理日志文件，避免日志文件过大影响系统性能。
- **依赖库更新**：定期更新项目依赖库，修复已知漏洞和兼容性问题。

## 未来规划

- **多平台支持**：扩展支持其他即时通讯平台，如Telegram、Slack等。
- **高级命令功能**：增加更多管理员命令，如系统重启、模块启停等。
- **Web界面**：开发基于Web的管理界面，提升管理员的操作体验。
- **更完善的错误恢复机制**：在系统发生严重错误时，自动重启相关模块或整个系统。

## 附录

- **常用命令**：
  - 启动系统：`python main.py`
  - 查看日志：`tail -f logs/system.log`
  - 添加接收者：管理员发送命令 `/添加接收者 <接收者名称> <初始次数>`
  - 删除接收者：管理员发送命令 `/删除接收者 <接收者名称>`
  - 更新剩余次数：管理员发送命令 `/更新剩余次数 <接收者名称> <变化量>`
  - 查询接收者信息：管理员发送命令 `/查询接收者 <接收者名称>`
  - 获取所有接收者：管理员发送命令 `/获取所有接收者`
  - 查询日志：管理员发送命令 `/查询日志`
  - 查询浏览器状态：管理员发送命令 `/查询浏览器`
  - 帮助：管理员发送命令 `/帮助`

- **参考资料**：
  - [ItChat GitHub 仓库](https://github.com/littlecodersh/ItChat)
  - [DrissionPage 文档](https://drissionpage.readthedocs.io/)
  - [SQLite 官方文档](https://www.sqlite.org/docs.html)

## 版本更新日志

### 1.1.0

- **新增**：
  - `AdminCommandsHandler`组件，用于处理管理员命令。
  - 配置管理集成，使用`ConfigManager`动态加载配置。
  - 增强的二维码回调功能，支持图形界面显示。
  - 支持通过管理员命令查询日志和浏览器状态。
  - 新增`PointManager`模块，用于管理积分。
  - 新增`StatisticsManager`模块，用于管理和记录系统统计数据。
  - 新增`XKW`组件，负责具体的下载任务执行。
  - 新增`AutoDownloadManager`模块，负责下载任务的调度和多实例浏览器控制。

- **更新**：
  - `ItChatHandler`删除旧会话文件，确保每次登录为全新会话。
  - `MessageHandler`集成管理员命令处理，增强消息处理逻辑。
  - `Uploader`支持多线程上传，优化上传效率和稳定性。
  - `ErrorHandler`实现集中式异常处理，增强日志记录和错误通知。
  - `PointManager`新增积分管理功能，集成数据库支持。
  - `StatisticsManager`实现统计数据的记录与持久化。
  - `XKW`增强下载任务管理，支持多标签页和任务重试机制。
  - `AutoDownloadManager`实现多实例浏览器控制和任务调度优化。

- **修复**：
  - 修复了多群组和多个人监控时的潜在问题。
  - 修复了部分消息类型未被正确处理的BUG。

---

## 许可证

本项目采用[MIT许可证](LICENSE)进行许可。

---

# 联系方式

如有任何问题或建议，欢迎通过以下方式联系：

- **邮箱**：support@wechat-automation.com
- **GitHub**：[WeChat Automation Project](https://github.com/your-repo/wechat-automation-project)

# 结束语

感谢您使用微信自动化上传系统！希望本项目能够有效提升您的工作效率。如需更多功能或有任何反馈，请随时与我们联系。