# wechat-automation-project

# 微信自动化上传系统技术文档

## 目录

1. [概述](#概述)
2. [系统架构](#系统架构)
3. [组件详解](#组件详解)
    - [1. ItChatHandler](#1-itchathandler)
    - [2. MessageHandler](#2-messagehandler)
    - [3. AutoClicker](#3-autoclicker)
    - [4. Uploader](#4-uploader)
    - [5. auto_download](#5-auto_download)
    - [6. ErrorHandler](#6-errorhandler)
    - [7. Notifier](#7-notifier)
4. [工作流程](#工作流程)
5. [配置说明](#配置说明)
6. [部署与设置](#部署与设置)
7. [故障排除](#故障排除)
8. [安全性与最佳实践](#安全性与最佳实践)
9. [未来规划](#未来规划)
10. [附录](#附录)

---

## 概述

本技术文档详细介绍了微信自动化上传系统的架构、各组件功能及其相互作用。该系统基于Python和ItChat库，主要用于监控指定微信群组和个人中的消息，提取URL链接，自动下载相关文件，并将文件上传回微信群组。系统还具备错误处理和通知功能，确保在出现问题时及时反馈。此外，系统引入了管理员功能，允许管理员执行特定命令，如查询日志和浏览器状态。

## 系统架构

微信自动化上传系统采用模块化设计，主要包括以下关键组件：

1. **ItChatHandler**：负责与微信的交互，包括登录、监听群组和个人消息等。
2. **MessageHandler**：处理从群组和个人接收到的消息，提取URL链接并进行验证。
3. **AutoClicker**：自动化处理提取的URL，如打开链接以触发下载，并自动退出浏览器。
4. **Uploader**：将下载的文件上传到指定的微信群组。
5. **auto_download**：自动化下载文件，将下载的文件保存到本地，并记录文件对应的ID和链接。
6. **ErrorHandler**：捕捉并处理系统运行中的异常，确保系统稳定性。
7. **Notifier**：负责发送通知，如错误报告、操作反馈和管理员命令响应。

各组件通过事件驱动和回调机制相互协作，共同完成消息监控、文件下载与上传的自动化流程。

## 组件详解

### 1. ItChatHandler

**作用**：

- 负责与微信客户端建立连接，处理登录过程。
- 监听指定微信群组和个人中的消息，并将消息传递给MessageHandler进行处理。
- 支持多群组和多个人的监控和上传功能。
- 连接Uploader功能，实现对应群组的文件上传功能。
- 记录群组或个人发送的链接ID，并传送到`upload_urls`列表。
- 支持管理员功能，允许管理员执行特定命令，如查询日志和浏览器状态。

**逻辑**：

1. **登录微信**：通过ItChat库实现微信登录，支持二维码扫描登录和热重载功能。改进后删除旧的会话文件，确保每次登录都是全新的会话。
2. **初始化会话**：获取并更新微信中的群组和个人信息，确保能够正确识别和监听目标群组和个人。
3. **消息监听**：注册消息处理函数，监听群组和个人中的各种消息类型（如文本、附件、分享等）。
4. **回调处理**：将接收到的消息传递给MessageHandler进行进一步处理。
5. **二维码处理**：改进后的二维码回调功能，不仅保存二维码图片，还将二维码数据发送到GUI队列以支持图形界面显示。
6. **管理员命令支持**：支持管理员通过特定命令与系统交互，如添加或删除接收者，更新剩余次数等。

**更新内容**：

- **多群组和个人监控**：支持同时监控多个微信群组和指定的个人联系人。
- **管理员支持**：引入管理员列表，允许管理员发送特定命令以查询系统日志或浏览器状态。
- **二维码回调增强**：二维码图片不仅保存到本地，还发送到GUI队列，支持图形界面显示。
- **错误处理与日志记录**：增强了错误处理机制，确保在登录或运行过程中出现问题时能够及时记录并通知。
- **Uploader绑定**：允许外部绑定Uploader实例，以便在消息处理后进行文件上传。

### 2. MessageHandler

**作用**：

- 处理来自微信群组和个人的消息，提取其中的URL链接。
- 验证提取的URL是否符合预定义的规则，并触发相应的自动化操作。
- 支持管理员命令，如添加/删除接收者、更新剩余次数、查询接收者信息等。
- 支持管理员命令，如查询日志和浏览器状态。

**逻辑**：

1. **消息解析**：接收ItChatHandler传递的消息对象，提取消息内容。
2. **URL提取**：使用正则表达式从消息内容中提取所有符合条件的URL链接。
3. **URL验证**：根据配置中的规则，验证提取的URL是否合法有效。
4. **触发自动化操作**：对于通过验证的URL，调用AutoClicker模块进行后续处理，如打开链接以启动文件下载。
5. **管理员命令处理**：
    - **添加接收者**：允许管理员添加新的接收者，并设置初始下载次数。
    - **删除接收者**：允许管理员删除现有接收者。
    - **更新剩余次数**：允许管理员更新接收者的剩余下载次数。
    - **查询接收者信息**：允许管理员查询特定接收者的剩余次数。
    - **获取所有接收者**：允许管理员获取所有接收者的列表。
    - **帮助命令**：提供可用命令的帮助信息。

**更新内容**：

- **管理员命令支持**：新增处理管理员发送的特定命令，如添加/删除接收者，更新剩余次数，查询接收者信息，获取所有接收者，以及帮助命令。
- **日志管理**：能够读取并发送最新的日志内容，帮助管理员快速了解系统状态。
- **浏览器控制器集成**：支持通过命令捕获浏览器标签页的截图，并将截图发送给管理员。
- **增强的消息处理**：支持处理更多类型的消息（如分享类型），并根据消息来源（群组或个人）进行不同的处理逻辑。

### 3. AutoClicker

**作用**：

- 自动化处理提取的URL链接，将URL添加到下载任务队列中，自动触发文件下载。
- 管理浏览器实例，确保下载过程顺利进行，并在必要时自动退出浏览器以释放资源。

**逻辑**：

1. **打开URL**：接收MessageHandler传递的有效URL链接，使用系统默认浏览器或指定的浏览器自动打开链接。
2. **启动下载**：通过打开链接触发文件的自动下载，确保下载过程顺利进行。
3. **反馈机制**：在需要时，提供下载启动的日志记录或通知。
4. **浏览器自动退出**：防止浏览器页面打开过多，导致文件下载异常，自动退出浏览器释放资源。

**更新内容**：

- **线程安全与并发控制**：使用线程锁（`threading.Lock`）确保在多线程环境下对共享资源的安全访问。
- **下载任务管理**：集成了`XKW`类，通过多线程和任务队列（`queue.Queue`）管理下载任务，支持批量和单个URL的下载。
- **错误处理**：在各个下载步骤中捕捉并处理异常，确保系统稳定性。
- **日志记录**：详细记录每个下载任务的状态，包括成功、失败及重试信息。

### 4. Uploader

**作用**：

- 连接ItChatHandler和auto_download，将下载完成的文件上传回指定的微信群组，实现计数功能。
- 管理上传任务队列和多线程处理，确保高效稳定的文件上传。
- 维护接收者的下载计数和剩余量，并通过每日通知系统向管理员报告系统状态。

**逻辑**：

1. **文件检查**：确认下载的文件存在且已完成下载（大小稳定）。
2. **文件重命名**：将文件名修改为 `[soft_id]原文件名`，便于追踪和管理。
3. **上传任务管理**：
    - 使用独立的上传线程和上传任务队列（`queue.Queue`）管理上传任务。
    - 支持多线程并发上传，提高上传效率。
4. **文件上传**：
    - 切换到指定的聊天窗口。
    - 使用wxauto库发送文件到目标微信群组或个人联系人。
    - 实现重试机制，确保上传成功。
5. **计数器集成**：
    - 使用SQLite数据库记录每个接收者的下载计数和剩余量。
    - 扣除上传成功后的剩余次数，并记录每日下载量。
6. **每日通知系统**：
    - 定时每天晚上10点半发送下载量和剩余量的通知消息到指定的群组或个人账号。
    - 重置每日下载计数，准备新的统计周期。
7. **错误处理与日志记录**：
    - 捕捉上传过程中的异常，通过ErrorHandler进行统一处理。
    - 记录详细的日志，便于后续追踪和调试。
8. **管理员命令支持**：
    - 允许管理员通过命令添加、删除接收者，更新剩余次数，以及查询接收者信息。

**更新内容**：

- **多线程上传处理**：通过独立的上传线程和上传任务队列（`queue.Queue`）管理上传任务，确保高效处理多个文件上传请求。
- **错误通知**：在上传失败时，通过`ErrorHandler`和`Notifier`模块发送错误通知，确保及时响应和处理问题。
- **文件重命名与管理**：在上传前对文件进行重命名，确保文件名中包含`soft_id`，便于追踪和管理。
- **计数器集成**：维护每个接收者的下载计数和剩余量，定期保存和更新计数器数据，支持每日下载量统计和通知。
- **每日通知系统**：定时发送每日下载量和剩余量的通知消息到指定的群组或个人账号，帮助管理员了解系统运行状态。
- **数据库管理**：集成SQLite数据库，管理接收者信息、下载记录和计数器数据。
- **管理员命令支持**：新增方法支持管理员添加、删除接收者，更新剩余次数，以及查询接收者信息。

### 5. auto_download

**作用**：

- 自动化下载文件，将下载的文件保存到本地，并记录文件对应的ID和链接。

**逻辑**：

1. **文件下载**：使用DrissionPage库（基于Chromium的自动化浏览器）进行文件下载处理。
2. **文件保存**：将下载的文件保存到本地指定目录，并记录文件对应的`soft_id`和链接。
3. **下载任务管理**：通过多线程和任务队列管理下载任务，支持高并发下载。
4. **截图功能**：提供捕获所有浏览器标签页截图的功能，支持管理员命令查询浏览器状态。

**更新内容**：

- **多线程下载支持**：使用`ThreadPoolExecutor`和任务队列（`queue.Queue`）管理下载任务，支持同时处理多个下载请求。
- **文件匹配与验证**：通过文件名匹配和文件大小稳定性检查，确保下载文件完整且未损坏。
- **错误处理**：在下载过程中捕捉并处理各种异常，包括页面上下文丢失、网络问题等，确保系统稳定性。
- **浏览器控制与优化**：配置Chromium浏览器选项（如不加载图片），优化下载性能，并提供截图功能以支持管理员的浏览器状态查询。
- **任务重试机制**：在下载失败时自动重试，确保高成功率的下载任务处理。

### 6. ErrorHandler

**作用**：

- 捕捉并处理系统运行中的各种异常，确保系统的稳定性和可靠性。

**逻辑**：

1. **异常捕捉**：在各个模块中捕捉到的异常会传递给ErrorHandler进行统一处理。
2. **日志记录**：详细记录异常信息，包括异常类型、堆栈跟踪等，便于问题排查。
3. **通知发送**：通过Notifier模块，向指定的接收者发送错误通知，确保及时响应和修复问题。
4. **状态检查**：在发送通知前，确认微信的登录状态，避免因微信未登录导致进一步的错误。

**更新内容**：

- **集中式异常处理**：所有模块的异常均通过ErrorHandler进行统一处理，简化错误管理。
- **增强的日志记录**：详细记录每个异常的上下文信息，便于快速定位和修复问题。
- **通知集成**：与Notifier模块紧密集成，确保在发生严重错误时能够及时通知管理员或相关人员。

### 7. Notifier

**作用**：

- 负责发送各种通知，如错误报告、操作反馈和管理员命令响应，确保用户能够及时了解系统状态。

**逻辑**：

1. **通知类型**：支持多种通知方式，如通过微信、邮件、日志等。
2. **消息格式**：根据通知类型，格式化消息内容，确保信息传递的准确性和清晰度。
3. **发送机制**：调用相应的API或接口，发送通知消息到指定的接收者或平台。
4. **错误处理**：在发送通知过程中，如果发生异常，通过ErrorHandler模块进行处理，避免递归错误。

**更新内容**：

- **多种通知渠道支持**：支持通过微信发送通知，未来可扩展至邮件、Slack等其他平台。
- **管理员命令响应**：针对管理员发送的命令，格式化并发送相应的反馈消息，如日志内容和浏览器截图。
- **长消息处理**：实现长消息的分段发送，确保超过限制的消息能够完整传达。
- **图像通知支持**：支持发送截图或其他图像文件，满足管理员命令中对浏览器截图的需求。

## 工作流程

1. **系统启动**：
   - 系统加载配置文件，初始化各个模块（ItChatHandler、MessageHandler、AutoClicker、Uploader、auto_download、ErrorHandler、Notifier）。
   - ItChatHandler登录微信，并获取目标群组和个人的UserName信息。

2. **消息监控与处理**：
   - ItChatHandler监听指定微信群组和个人的消息，接收到新消息后，将消息传递给MessageHandler。
   - MessageHandler解析消息内容，提取URL链接，并进行验证。
   - 对于通过验证的URL，MessageHandler调用AutoClicker模块自动打开链接，启动文件下载。

3. **文件下载与上传**：
   - AutoClicker通过XKW模块处理下载任务，自动下载文件到本地指定目录。
   - 下载完成后，AutoClicker将文件路径和对应的`soft_id`传递给Uploader。
   - Uploader将文件上传到指定的微信群组，并更新下载计数和剩余量。

4. **管理员命令处理**：
   - 管理员发送特定命令（如添加/删除接收者、更新剩余次数、查询接收者信息、获取所有接收者、查询日志、查询浏览器状态）。
   - MessageHandler识别命令并执行相应操作，通过Notifier模块将结果反馈给管理员。

5. **错误处理与通知**：
   - 在各个步骤中，如果发生异常，ErrorHandler捕捉并记录错误。
   - ErrorHandler通过Notifier模块发送错误通知，确保用户及时了解并处理问题。

## 配置说明

系统通过`config.json`文件进行配置，涵盖了微信登录信息、监控群组和个人、文件上传设置、日志记录、错误通知等各个方面。以下是各配置项的说明：

- **wechat**:
  - `login_qr_path`: 存储微信登录二维码的路径。
  - `monitor_groups`: 需要监控的微信群组名称列表。
  - `target_individuals`: 需要监控的个人联系人名称列表。
  - `admins`: 管理员列表，允许执行特定命令。

- **url**:
  - `regex`: 用于匹配消息中的URL链接的正则表达式。
  - `validation`: 是否启用URL验证。

- **download**:
  - `download_path`: 本地下载目录的路径。
  - `allowed_extensions`: 允许下载的文件扩展名列表。
  - `temporary_extensions`: 临时文件扩展名列表，用于识别未完成的下载文件。
  - `stable_time`: 文件大小稳定时间（秒），用于确认文件已下载完成。

- **upload**:
  - `target_groups`: 需要上传文件或分享链接的微信群组名称列表。
  - `target_individuals`: 需要上传文件的个人联系人名称列表。
  - `counts_file`: 计数器配置文件的路径，用于记录每日下载量和剩余量。
  - `database_path`: SQLite数据库文件的路径。

- **logging**:
  - `level`: 日志记录的级别（如INFO、DEBUG、ERROR）。
  - `file`: 日志文件的存储路径。
  - `directory`: 日志目录，用于存储多个日志文件。

- **error_notification**:
  - `method`: 错误通知的方式（如wechat、email等）。
  - `recipient`: 错误通知的接收者（如微信好友或群组）。
  - `error_recipient`: 错误通知的专用接收者（可选）。

- **itchat**:
  - `qr_check`:
    - `max_retries`: 最大重试次数，用于二维码扫描登录。
    - `retry_interval`: 重试间隔时间（秒）。

**注意事项**：

- 配置文件必须为有效的JSON格式，不能包含注释。
- 确保所有路径和群组、个人名称与实际情况一致，避免因配置错误导致功能失效。
- 根据企业微信的具体文件大小限制，调整上传逻辑和配置参数。
- 管理员功能需要在`admins`列表中正确配置管理员名称，确保只有授权用户可以执行特定命令。

## 部署与设置

1. **环境准备**：
   - 安装Python 3.7及以上版本。
   - 安装项目依赖库，可以通过`pip install -r requirements.txt`完成。

2. **配置文件设置**：
   - 编辑`config.json`文件，根据实际需求配置各项参数，如监控群组、个人、下载路径、上传目标等。

3. **运行系统**：
   - 启动主程序，系统将自动登录微信并开始监控指定的群组和个人消息。

4. **管理员功能**：
   - 确保管理员已在配置文件中正确设置，可以通过发送特定命令来管理接收者、查询系统日志或浏览器状态。

## 附录

- **常用命令**：
  - 启动系统：`python main.py`
  - 查看日志：`tail -f logs/system.log`
  - 添加接收者：管理员发送命令 `/添加接收者 <接收者名称> <初始次数>`
  - 删除接收者：管理员发送命令 `/删除接收者 <接收者名称>`
  - 更新剩余次数：管理员发送命令 `/更新剩余次数 <接收者名称> <变化量>`
  - 查询接收者信息：管理员发送命令 `/查询接收者 <接收者名称>`
  - 获取所有接收者：管理员发送命令 `/获取所有接收者`
  - 查询日志：管理员发送命令 `/查询日志`
  - 查询浏览器状态：管理员发送命令 `/查询浏览器`
  - 帮助：管理员发送命令 `/帮助`

- **参考资料**：
  - [ItChat GitHub 仓库](https://github.com/littlecodersh/ItChat)
  - [DrissionPage 文档](https://drissionpage.readthedocs.io/)
  - [SQLite 官方文档](https://www.sqlite.org/docs.html)

# 说明

根据您的最新代码更新，**DownloadWatcher** 模块已被删除，因此技术文档中的相关部分已被移除，并相应调整了工作流程和组件详解部分。此外，**ErrorHandler** 和 **Notifier** 模块已进行了更新，增强了错误处理和通知功能。确保其他配置和模块的描述与实际代码一致，必要时可以进一步调整技术文档以反映更多代码变更。

特别地，**Uploader** 模块已全面更新，新增了多线程上传处理、数据库管理、每日通知系统以及管理员命令支持等功能。**ItChatHandler** 和 **MessageHandler** 也进行了更新，支持管理员通过特定命令管理接收者和系统状态查询。请参考上述“组件详解”中的“1. ItChatHandler”和“2. MessageHandler”部分，了解详细的功能和逻辑。

*本文档由微信自动化上传系统团队维护，最后更新于2024年4月27日。*

# 许可证

本项目采用[MIT许可证](LICENSE)进行许可。